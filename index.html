<!doctype html>
<html lang="en">
	<head>
		<title>BlackJack</title>
		<link rel="stylesheet" href="css/screen.css" />
		<script src="js/easeljs-0.7.1.min.js"></script>
		<script src="js/tweenjs-0.5.1.min.js"></script>
		<script src="js/jquery1.7.2.js"></script>
		<script src="js/game.js"></script>
		<script>

		/*
			Notes: Pass the transactions/banking team hand:{{"clubs", "three"}, {"spades", "ace"}}, winAmount:51.5, 
		*/
			var circle = new createjs.Shape();
            var stage;
            var endGameContainer;
            var spritesheet;
            var userHandSprites;
            var userHand;
            var dealerHand;
            var dealerHandSprites;
            var dealerCards;
            var deckX = 965;
			var deckY = 80;
			var takingInput = true;
			var user = null;
			var chipButtons = new Array();
			var namedSprites = {};
			var infoBlock;
			var menuBlock;
			var mainMenuButton;
			var currentMoneyText;
			var currentBetText;
			var timerText;
			var serverURL = 'http://localhost:8080/';
			var timerInterval = 300; //milliseconds per turn
			var fpsCount = 0;

            var Cards = {
            	Ace: 1,  Two: 2,  Three: 3, Four: 4,  
            	Five: 5, Six: 6,  Seven: 7, Eight: 8,
            	Nine: 9, Ten: 10, Jack: 11, Queen: 12, King: 13
            };
			var Suites = {
            	Clubs: 1,  Spades: 2, Hearts: 3, Diamonds: 4
            };
			function Dealer() {
				
			}

            function getCardSprite(CardType, SuiteType){
			
            	var sprite = new createjs.Sprite(spritesheet);

            	sprite.gotoAndStop(52);
            	sprite.cardType = CardType;
				sprite.suiteType = SuiteType;
				sprite.scaleX = -1;

            	return sprite;
            }

            function showCardFace(cardSprite)
            {
            	console.log("showing card face: " + cardSprite.cardType + " suit: " + cardSprite.suiteType);
            	cardSprite.gotoAndStop(cardSprite.cardType + (cardSprite.suiteType-1)*13 - 1);
            }


	        function init() {
	        	var data = {
					images: ["assets/cards.png"],
					frames: {width:73, height:98, count:53}
				};
				spritesheet = new createjs.SpriteSheet(data);
	        	stage = new createjs.Stage("demoCanvas");
				stage.addChild(new createjs.Bitmap("assets/background.png"));

				//Hit button
				var hitButton = new createjs.Bitmap('assets/custom_hit.png');
				hitButton.enabled = true;
				hitButton.x = 730;
				hitButton.y = 612;
				hitButton.addEventListener("click", onHitButtonClicked);
				stage.addChild(hitButton);

				//Stand button
				var standButton = new createjs.Bitmap('assets/custom_stand.png');
				standButton.enabled = true;
				standButton.x = 900;
				standButton.y = 590;
				standButton.addEventListener("click", onStandButtonClicked);
				stage.addChild(standButton);

				namedSprites['standButton'] = standButton;
				namedSprites['hitButton'] = hitButton;

				//Bet buttons
				var chipColors = new Array("red", "blue", "green", "black");
				var betAmounts = new Array(100, 200, 500, 1000);
				for(var i=0; i<chipColors.length; i++)
				{
					(function(){
						var chipColor = chipColors[i];
						var betAmount = betAmounts[i];

						betButton = new createjs.Bitmap('assets/'+chipColor+'_chip_small.png');
						betButton.x = 700 + i*35;
						betButton.y = 580;
						betButton.enabled = true;
						betButton.addEventListener("click", function(event){
							if(betButton.enabled)
							{
								self.onBetButtonClicked(betAmount);
							}
						});
						stage.addChild(betButton);
						chipButtons.push(betButton);
					}());
				}

				infoBlock   = new createjs.Container();
	        	infoBlock.x = 10;
	        	infoBlock.y = 10;
	        	infoBlock.addChild(new createjs.Bitmap('assets/custom_info_block.png'));
	        	currentMoneyText = new createjs.Text('', "18px Arial", "#500000");
				currentMoneyText.set({
	                x:25,
	                y:20
	            });
	            currentBetText = new createjs.Text('', "18px Arial", "#500000");
	            currentBetText.set({
	            	x:25,
	            	y:45
	            });
	            timerText = new createjs.Text('', '18px Arial', '#500000');
	            timerText.set({
	            	x:25,
	            	y:70
	            });
	            infoBlock.addChild(currentBetText);
	            infoBlock.addChild(currentMoneyText);
	            infoBlock.addChild(timerText);
	        	stage.addChild(infoBlock);

				var menuBackground = new createjs.Bitmap("assets/end_game.png");
	        	menuBlock = new createjs.Container();
	        	menuBlock.x = ($('#demoCanvas').width() - menuBackground.getBounds().width)/2;
	        	menuBlock.y = 240;
	        	menuBlock.addChild(menuBackground);
	        	mainMenuButton = new createjs.Bitmap('assets/play_again.png');
				mainMenuButton.enabled = true;
				mainMenuButton.x = (menuBackground.getBounds().width - mainMenuButton.getBounds().width)/2;
				mainMenuButton.y = 100;
				mainMenuButton.addEventListener("click", onMainMenuButtonClicked);
				menuBlock.addChild(mainMenuButton);

				var menuButton = new createjs.Bitmap('assets/custom_hit.png');
				menuButton.x = 30;
				menuButton.y = 550;
				menuButton.addEventListener('click', function(event){
					stage.addChild(menuBlock);
				});
				stage.addChild(menuButton);

				
				createjs.Ticker.setFPS(30);
				createjs.Ticker.addEventListener("tick", stage);

				user = new Player();
				user.setOnCashChangedCallback(onUserCashChanged);
				user.onBetChanged(onUserBetChanged);
				updateTimerText();

				startGame();
	        }

	        var onTick = function(event){
	        	fpsCount += 1;

	        	if(fpsCount%30 == 0)
	        		updateTimerText();

	        	if(fpsCount >= timerInterval){
	        		fpsCount = fpsCount % timerInterval;
	        		nextTurn();
	        	}
	        	
	        }

	        var nextTurn = function(){
	        	endUserTurn();
	        }

	        var newGame = function(){

	  			//$.get( serverURL + 'join', function( data ) {
				//   alert( "Joined Game: " + data.game_id +'\nNumber of players: '+data.number_of_players);
				//});

	        	var deck = new Deck();
				deck.shuffle();

				dealerHand        = new Hand(deck);
				userHand          = new Hand(deck);
				dealerHandSprites = new Array();
				userHandSprites   = new Array();
				dealerCards       = dealerHand.getHand();
				userCards         = userHand.getHand();

				user.setHand(userHand);

				animationDelay = 0;

				for(var i=0; i<dealerCards.length; i++) {
					setTimeout(function(){
						addDealerCard(false);
					}, animationDelay);
					animationDelay += 250;
				}

				animationDelay += 500;

				for(var i=0; i<userCards.length; i++) {
					setTimeout(function(){
						addCardSprite(true);
					}, animationDelay);
					animationDelay += 250;
				}

				createjs.Ticker.addEventListener("tick", onTick);
				fpsCount = 0;
				updateTimerText();
	        }

	        var addDealerCard = function(shouldFlip){
	        	if(!takingInput)
	        		return;

	        	var cards = dealerHand.getHand();
	        	var numberOfCards = dealerHandSprites.length;
	        	var newCard = cards[numberOfCards];
	        	var newDealerCard = getCardSprite(newCard.getNumber(), newCard.getSuitNumber());
				newDealerCard.x = 450 + numberOfCards*50;
				newDealerCard.y = 140 + numberOfCards*5;
				dealerHandSprites.push(newDealerCard);
				animateNewCard(newDealerCard, 450 + numberOfCards*50, 140+numberOfCards*5, numberOfCards>0);
	        }

	        var addCardSprite = function(shouldFlip){
	        	if(!takingInput)
	        		return;

	        	var cards = userHand.getHand();
	        	var numberOfCards = userHandSprites.length;
	        	var newCard = cards[numberOfCards];
	        	var newUserCard = getCardSprite(newCard.getNumber(), newCard.getSuitNumber());
				userHandSprites.push(newUserCard);
				animateNewCard(newUserCard, 535+numberOfCards*12, 415+numberOfCards*6, shouldFlip);
				createjs.Tween.get(null).to({}, 800).call(function(){
					checkEndGame();
			    });
	        }

	        var checkEndGame = function(){
	        	if(!takingInput)
	        		return;

	        	if(userHand.score() > 21)
	        	{
	        		endGame();
	        	}
	        	else if(userHand.score() == 21)
	        	{
	        		finishDealerHand();
	        	}
	        }

	        var endGame = function(){
	        	if(!takingInput)
	        		return;

	        	takingInput = false;
	        	if(userHand.score() > 21)
	        		userBust();
	        	else if(dealerHand.score() > 21)
	        		dealerBust();
	        	else if(userHand.score() > dealerHand.score())
	        		userWin();
	        	else
	        		userLost();
	        }

	        var userBust = function(){
	        	showEndGame('You went bust!', false);
	        	user.lostBet();
	        }

	        var dealerBust = function(){
	        	showEndGame('Dealer busted!', true);
	        	user.wonBet();
	        }

	        var userWin = function(){
	        	showEndGame('You win!', true);
	        	user.wonBet();
	        }

	        var userLost = function(){
	        	showEndGame('Dealer wins', false);
	        	user.lostBet();
	        }

	        var showEndGame = function(message, didWin){
	        	
	        	var endGameImage = new createjs.Bitmap("assets/custom_end_game.png");

	        	var playAgainButton = new createjs.Bitmap("assets/custom_play_again.png");
	        	playAgainButton.addEventListener("click", onPlayAgainClicked);
	        	playAgainButton.x = (endGameImage.getBounds().width - playAgainButton.getBounds().width)/2;
	        	playAgainButton.y = 140;

				var text = new createjs.Text(message, "bold 42px Arial", "#500000");
				text.set({
	                textAlign: 'center',
	                x:200,
	                y:15
	            });

				if(didWin)
		            var detailMessage = 'You won $' + user.getCurrentBet() + '!';
		        else
		        	var detailMessage = 'You lost $'+user.getCurrentBet() + '.';

	            var detailText = new createjs.Text(detailMessage, "30px Arial", "#500000");
	            detailText.set({
	            	textAlign: 'center',
	            	x: 200,
	            	y: 80
	            });

	        	endGameContainer   = new createjs.Container();
	        	endGameContainer.x = ($('#demoCanvas').width() - endGameImage.getBounds().width)/2;
	        	endGameContainer.y = 240;

	        	endGameContainer.addChild(endGameImage);
	        	endGameContainer.addChild(text);
	        	endGameContainer.addChild(detailText);
	        	endGameContainer.addChild(playAgainButton);

	        	stage.addChild(endGameContainer);
	        }

	        var onPlayAgainClicked = function(event){
				resetStage();
	        	startGame();
	        }

	        var resetStage = function(){
	        	stage.removeChild(endGameContainer);

	        	for(var i=0; i<dealerHandSprites.length; i++)
	        	{
	        		stage.removeChild(dealerHandSprites[i]);
	        	}
	        	for(var i=0; i<userHandSprites.length; i++)
	        	{
	        		stage.removeChild(userHandSprites[i]);
	        	}

	        	enableBetting();
	        	enableButton(namedSprites['hitButton']);
	        	enableButton(namedSprites['standButton']);
	        	
	        	stage.update();
	        }

	        var startGame = function(){
	        	takingInput = true;
	        	newGame();
	        }

	        var onHitButtonClicked = function(event){
	        	if(takingInput)
	        	{
		        	userHand.hitMe();
		        	addCardSprite(true);
		        	fpsCount = 0;
		        	updateTimerText();
	        	}
	        }

	        var onBetButtonClicked = function(betAmount){
	        	user.increaseBet(betAmount);
	        }

	        var finishDealerHand = function(){

	        	if(!takingInput)
	        		return;

	        	if(dealerHand.score() < 17 && dealerHand.length() < 5){
	        		dealerHand.hitMe();
	        	}
	        	else
	        	{
	        		endGame();
	        	}
	        	if(dealerHand.length() > dealerHandSprites.length)
	        	{
	        		addDealerCard(false);
	        	}

				setTimeout(function(){
					if(dealerHand.score() < 17 && dealerHand.length() < 5){
						finishDealerHand();
					}
					else
						endGame();
				}, 1000);
		    }

		    var animateNewCard = function(cardSprite, destinationX, destinationY, shouldFlip){
		    	stage.addChild(cardSprite);
		    	if(shouldFlip){
	    			cardSprite.rotation = -70;
					cardSprite.scaleX = -1;
				}

				cardSprite.x = deckX;
				cardSprite.y = deckY;

				if(!shouldFlip)
					destinationX += cardSprite.getBounds().width;

				var destionationScaleX = cardSprite.scaleX;;
				if(shouldFlip)
					destionationScaleX = 1;

				createjs.Tween.get(cardSprite).to({x:destinationX,y:destinationY, rotation:0, scaleX:destionationScaleX},800,createjs.Ease.quadInOut);

				if(shouldFlip){
					createjs.Tween.get(cardSprite).to({},400,createjs.Ease.quadInOut).call(function(){
						showCardFace(cardSprite);
					});
				}
		    }

		    var flipCard = function(cardSprite){

		    	if(cardSprite.scaleX == 1)
		    		return;
		    	console.log("x: " + cardSprite.x + " width: "+cardSprite.getBounds().width);
		    	createjs.Tween.get(cardSprite).to({rotation:0, scaleX:1, x: cardSprite.x-cardSprite.getBounds().width},800,createjs.Ease.quadInOut);
	        	createjs.Tween.get(cardSprite).to({},400,createjs.Ease.quadInOut).call(function(){
					showCardFace(cardSprite);
				});
		    }

	        var onStandButtonClicked = function(event){
	        	if(!event.target.enabled)
	        		return;

	        	endUserTurn();
	        }

	        var endUserTurn = function(event){
	        	disableButton(namedSprites['hitButton']);
	        	disableButton(namedSprites['standButton']);
	        	disableBetting();
	        	disableTimer();
	        	if(takingInput)
	        	{
		        	var cardSprite = dealerHandSprites[0];
		        	flipCard(cardSprite);
		        	setTimeout(function(){
						finishDealerHand();
					}, 1000);
		        }
	        }

	        var disableTimer = function(){
	        	createjs.Ticker.removeEventListener("tick", onTick);
	        }


	        var disableBetting = function(){
	        	for(var i=0; i<chipButtons.length; i++)
	        	{
	        		disableButton(chipButtons[i]);
	        	}
	        }
	        var enableBetting = function(){
	        	for(var i=0; i<chipButtons.length; i++)
	        	{
	        		enableButton(chipButtons[i]);
	        	}
	        }
	        var enableButton = function(buttonSprite){
	        	createjs.Tween.get(buttonSprite).to({alpha:1},350, createjs.Ease.quadOut);
        		buttonSprite.enabled = true;
	        }
	        var disableButton = function(buttonSprite){
	        	createjs.Tween.get(buttonSprite).to({alpha:0.6},350, createjs.Ease.quadOut);
        		buttonSprite.enabled = false;
	        }

	        var onUserCashChanged = function(event){
	        	currentMoneyText.set({
	        		text: ('Bank: $'+user.getCash())
	        	});
	        }
	        var onUserBetChanged = function(event){
	        	currentBetText.set({
	        		text: ('Bet: $'+user.getCurrentBet())
	        	});
	        }

	        var updateTimerText = function(){
	        	timerText.set({
	        		text: Math.round((timerInterval-fpsCount)/30) + ' seconds'
	        	});
	        }

	        var onMainMenuButtonClicked = function(event){
	        	window.location = "http://casino.curtiswendel.me/gamefloor.html";
	        }

	    </script>
	</head>
	<body onLoad="init();">
		<div style="display:none;">
			<img src="assets/background.png" />
			<img src="assets/custom_hit.png" />
			<img src="assets/custom_hit.png" />
			<img src="assets/custom_stand.png" />
			<img src="assets/custom_info_block.png" />
		</div>
	    <canvas id="demoCanvas" width="1200" height="800">
	    </canvas>
	</body>
</html>